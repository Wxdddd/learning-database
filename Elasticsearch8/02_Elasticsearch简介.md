## Lucene简介

​		Lucene是一个免费、开源、高性能、纯Java编写的**全文检索引擎**，是目前市面上大部分开源全文检索引擎的工具包。比如Solr和Elasticsearch底层就是Lucene。**但它仅仅只是一个工具包，并非一个完整的全文检索引擎，所以很少有但是使用Lucene进行全文检索的**。主要包含如下模块：

- **Analysis 模块**：主要负责词法分析及语言处理，也就是我们常说的分词，通过该模块可最终形成存储或者搜索的最小单元Term。
- **Index 模块**：主要负责索引的创建工作。
- **Store 模块**：主要负责索引的读和写，主要是对文件的一些操作，其主要目的是抽象出和平台文件系统无关的存储。
- **QueryParser 模块**：主要负责语法分析，把查询语句生成Lucene 底层可以识别的条件。
- **Search 模块**：主要负责对索引的搜索工作。
- **Similarity 模块**：主要负责相关性打分和排序的实现。



​		在 Lucene 中，还有一些核心术语，主要涉及Term、词典(Term Dictionary，也叫作字典)、倒排表(PostingList)、正向信息和段(Segment)：

- **Term**：索引中最小的存储和查询单元。对于英文语境而言，一般是指一个单词;对于中文语境而言，一般是指一个分词后的词。
- **词典**：是Term 的集合。词典的数据结构有很多种，各有优缺点。如可以通过排序数组(通过二分查找来检索数据)、HashMap(哈希表，检索速度更快，属于空间换时间的模式) 、FST(Finite-State Transducer，有很好的压缩率)等来实现。
- **倒排表**：一篇文章通常由多个词组成，倒排表记录的是某个词在哪些文章中出现过。
- **正向信息**：原始的文档信息，可以用来做排序、聚合、展示等。
- **段**：索引中最小的独立存储单元。一个索引文件由一个或者多个段组成。在Lucene中，段有不变性，段一旦生成，在段上只能读取、不可写入。

## Elasticsearch简介

Elasticsearch 作为一个独立的搜索服务器，提供了非常方便的搜索功能。用户完全不用关心底层 Lucene 的细节，**只需要通过标准的 Http+RESTful 风格的 API，就可以进行索引数据的增删改查**。数据的输入**输出**采用 **JSON 格式**，以文档和面向对象的方式，这样就能非常方便地理解和表达领域数据。

**“Elasticsearch 就是一个 Compass 的 RESTful 实现啊！”**

同时，Elasticsearch 基于**分片和副本的方式**实现了一个分布式的 Lucene Directory，再结合Map-Reduce 的理念，实现了一个简单的搜索请求分发合并的策略，能轻松化解海量索引和分布式高可用的问题。

![image-20221215160030394](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221215160030394.png)

因此Elasticsearch是基于Lucene的一个分布式、可扩展、低延迟的高性能搜索与数据分析引擎。纯Java编写，对外提供Restful API接口方便不同客户端调用。

**主要优势如下**：

- 分布式实时文件存储。Elasticsearch可将被索引文档中的每一个字段存入索引，以便字段可以被检索到。‘
- 实时分析的分布式搜索引擎。Elasticsearch的索引分拆成多个分片，每个分片可以有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作;负载再平衡和路由会自动完成。
- 高可拓展性。Elasticsearch可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。当然，Elasticsearch也可以运行在单台PC上。
- 可插拔插件支持。Elasticsearch 支持多种插件，如分词插件、同步插件、Hadoop插件、可视化插件等。
- Elasticsearch 采用 Gateway 的概念，使得完备份更加简单
- 各节点组成对等的网络结构，某些节点出现故障时会自动分配其他节点代替其进行工作

### Elasticsearch与Solr区别

- Elasticsearch 自身带有分布式协调管理功能，而Solr 利用 Zookeeper 进行分布式管理
- Elasticsearch 仅支持json文件格式，而Solr 支持更多格式的数据
- Elasticsearch 本身更注重于核心功能，高级功能多有第三方插件提供，Solr 官方自带功能很多
- Elasticsearch实时搜索效率高于Solr

### Elasticsearch架构

![image-20221215160200916](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221215160200916.png)

### Elastic Stack

#### ElK三件套

**Logstash** 是一个开源的日志处理工具，用 JRuby 写的，主要特点是基于灵活的 Pipeline 管道架构来处理数据。什么意思呢？可以理解为将数据放进一个管道内进行处理，并且就跟真正的自来水管一样，管道由一截一截管子组成，每一个小管代表着一个数据处理的流程，每一个流程只做一件事情，然后可以根据数据的处理需要，选择多个不同类型的管子灵活组装。

Logstash 社区非常活跃，支持多种输入数据源和多种输出数据源。一开始， Elasticsearch 只是作为其中一个输出的存储，主要用于日志数据的存储。

不过，随着大家把日志发送到 Elasticsearch 之后，大家发现这家伙用起来很方便嘛，不仅能够存储大量的数据，水平伸缩还很方便。更关键的是，你能够很方便地把数据找出来，也就是进行全文搜索。

全文搜索在日志分析里面是非常基础的一个功能，通过一个关键字就能定位具体的详细日志，相比存放到关系型数据库和普通的文件存储，Elasticsearch 优势非常明显。于是 Logstash 搭配 Elasticsearch 变得很受欢迎。

不过 Logstash 自带的 UI 查询日志的界面有点简陋，于是有一个叫作 Rashid Khan 的运维工程师表示完全忍不了了，用 PHP 写了一个叫作 Kibana 的程序，一个更好看和更好用的前端界面。PHP 写完一版，他又用 Ruby 写一版，后面又用 AngularJS 写了一版，不仅有日志的搜索和查看，还加上了一些统计展示功能。

**Kibana** 的名字其实是俩个水果的名字的组合（Kiwi+Banana）。

这时，**Elasticsearch** 已经有 Facet 概念，也就是分面统计（ 注：1.0 之后推出了 Aggregation 来代替 Facet），可以对数据里面的某个字段进行单个维度的统计，支持多种统计类型。比如， TermFacet 可以计算字段里面某些值出现了多少次；Histogram Facet 还可以按时间区间进行汇总统计等。这些统计功能在前端 UI 就可以被利用起来，展示一些饼图、时间曲线等等，在运维的分析里面自然也都是需要的。慢慢的 **Kibana** 越做越复杂，支持的功能越来越多，Kibana 3 变得流行起来。

于是乎，**ELK 横空出世**（**Elasticsearch、Logstash 和 Kibana** 这三个产品的首字母缩写），**风靡了整个运维界**。

故事讲到这里，相信你们对于 Elasticsearch 就有了一个大概的认识，**可以用它做搜索，也可以用它做日志**。”

#### Elastic Stack 平台

Elastic 后面又引入了 **Beats 家族**。这是一系列非常轻量级的数据收集端，我给你介绍几个比较典型的，比如：

- **Packetbeat** 可以实时监听网卡流量，并实时解析网络协议数据，可用来做 NPM 网络数据分析；
- **Metricbea**t 可以用来收集服务器，以及服务器上部署的应用服务的各项监控指标数据，这样就可以替代 Zabbix 等传统的监控软件，来做服务器的性能指标分析；
- **Auditbeat**可以实时收集服务器的行为事件，用于安全方面的入侵检测和安全日志审计分析；
- **Winlogbeat**用于 Windows 平台的事件日志收集；
- **Filebeat** 用于日志文件的收集等。

> Elasticsearch、Logstash、Kibana、Beats ，这几个放在一起，就叫作 Elastic Stack。而且现在很多公司用Filebeat替换Logstash，将旧的三套件改成了新的EFK三件套。

![image-20221215160501587](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221215160501587.png)

Elastic 的版图越来越大，2017年，Elastic 收购 **Opbeat**，开源了业界第一个完整的 APM 解决方案，通过探针可以实现无侵入的代码级别的应用性能监控；2018年7月又收购了代码搜索 **[Insight.IO](http://insight.io/)**，后续可以实现代码级别的语义检索。今年又收购了一个做终端安全的厂商 Endgame。这样 Elastic Stack 这一个平台就可以同时做到：

- 日志分析
- 性能指标分析
- 安全日志分析
- APM 应用性能分析
- NPM 网络性能分析
- 网站站内搜索
- 企业级搜索
- 代码搜索
- 实时 BI 业务分析
- SIEM 解决方案
- 终端设备安全
- …

试想一下：

在一个风和日丽的下午，你手机上收到一条告警短信，于是点击链接，打开 Kibana 的监控仪表盘，发现某台服务器的 CPU 达到 100% 了。

于是，你顺手点击过滤这台服务器的所有相关信息，可以看到相关的日志显示，是这台服务器上面部署的某一个业务服务的 QPS 有显著下降，然后过滤到这个业务的日志，发现有很多异常的日志信息，前端 Nginx 代理日志还显示有很多请求被拒绝，看样子是后端的微服务处理能力达到瓶颈。

这个时候，继续点击 APM 的分析面板，切换到事务和会话分析界面，看到有很多数据库链接处于开启状态。你点击查看调用代码，立马就找到了性能瓶颈的原因，原来是某个类的某个方法调用 MySQL 却没有及时释放链接造成了泄露，于是修改这行代码，提交上线，问题解决。然后，你可以若无其事地继续浏览相亲网站啦。

尽管这是一个假想的例子，但是可以看到，**基于 Elastic Stack ，你可以覆盖一整套完整的，从全局性能监控到具体代码级别的排障和解决问题的过程，并且使用起来要比很多现有的方案更加高效和便捷**。



### Elastic上市

Elastic成立于2012年，在2018年公司上市，Elastic 上市后，其股票（股票代码：ESTC）更是大涨，发行价为 36 美元，最高涨至 74.20 美元，最终收盘价为 70.00 美元，涨幅 94.44%，几乎翻倍。目前超过 3.5+ 亿的产品下载，100万+ 名开发人员及 5,500+ 个客户。服务的国内外著名公司有国内外代表用户：

华为，腾讯，阿里巴巴，百度，携程，滴滴，京东，顺丰，宝洁，微软，思科，维基百科，Facebook, IBM, Grab, GitHub