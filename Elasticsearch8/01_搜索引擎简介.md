## 搜索引擎简介

### 1. 发展历史

搜索引擎发展一共经历了五个阶段，分别是：

1. FTP文件检索，检索多个FTP文件，用户输入文件名进行查找，搜索引擎返回FTP地址进行下载
2. 分类目录导航，此时搜索引擎就是一个导航网站，用户常用的网址都在此显示，典型的就是2345导航，360导航，UC导航等
3. 文本相关性检索，解决当网页内容与网页地址和标题不一致时，如何快速查询的问题，此时引入全文检索的概念，将网页内容、网页地址和标题进行强制关联，摒弃依靠单纯的网页地址和标题进行搜索
4. 网页链接分析，这就是目前搜索引擎（谷歌、百度等）使用的方式，谷歌推出的PageRank算法就是计算网站链接的热度，热度越高，越容易被其他用户搜索
5. 用户意图识别，这阶段搜索引擎以用户为中心，通过大数据进行分析为每位用户提供真正需要的搜索结果

搜索根据平台又可以分为站外搜索和站内搜索：

1. 站外搜索，就是全网搜索，比如谷歌、百度等搜索引擎，不仅包含文字搜索，还有图片、地图、语音等相关搜素
2. 站内搜索，理解为平台的内部搜索，比如淘宝、京东、天猫等电商搜索，或者饿了么、美团、点评等美食平台搜索，还有微信、Facebook等社交平台搜索等

### 2. 工作原理

搜素引擎的工作原理分为两阶段，**数据索引阶段**和**搜索阶段**。

数据索引来源比较广，比如网络爬虫、平台的数据录入、日志、一些数据分析的结果等。**此阶段主要包含：数据采集、预处理以及数据索引三部分。**

搜索阶段用户输入关键词、关键词预处理和关键词查询三个流程。

具体流程如下：![image-20221214152432627](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214152432627.png)

- 数据采集，包含爬虫抓取、后台录入、日志采集、数据分析结果等
- 预处理，比如删除不必要的标点符号、停用词、空格、字符串拼写错误等，然后进行分词。

### 3. 索引

#### 3.1 索引定义

索引是为了**加速对表中数据行的检索**而创建的一种分散的存储结构（key-value结构）。就类似于书本“目录”，通过“目录”快速找到对应的内容。

其主要目的就是**快速获取数据，减少查询时间**。

#### 3.2 正排索引

定义：以文档的ID为关键字，表中记录文档中每个字的位置信息，查找时扫描表中每个文档中字的信息直到找出所有包含查询关键字的文档。比如关系型数据库中的索引就是正向索引。

![image-20221214163102477](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214163102477.png)

这种组织方法在建立索引的时候结构比较简单，建立比较方便且易于维护。

- 若新文档加入，直接为该文档建立一个新的索引块，挂接在原来索引文件后面
- 若文档删除，则直接找到该文档号文档对应的索引信息，将其直接删除

**缺点**是：检索效率低，只能在一起简单的场景下使用。

#### 3.3 倒排索引

定义：倒排索引，以字或词为关键字进行索引，表中关键字所对应的记录表项记录了出现这个字或词的所有文档。

![image-20221214163350181](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214163350181.png)

优点：关键字查询时，由于可以一次得到关键字所对应的所有文档，所以查询效率高于正排索引

缺点：由于每个字或词对应的文档数量在动态变化，所以倒排索引的建立和维护都较为复杂

#### 3.4 倒排索引的构成

倒排索引主要由单词词典（Term Dictionary）和倒排列表（Posting List）组成。

![image-20221214163436494](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214163436494.png)

##### 3.4.1 单词词典（Term Dictionary）

记录所有文档的单词（一般都比较大）和记录单词到倒排列表的关联信息。一般用**B+Tree** 来实现，存储在内存。

以以上文档内容为例，构建B+tree如下：https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html
B+tree相关文章：https://www.jianshu.com/p/171ba693f747

![image-20221214163715632](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214163715632.png)

>B+树
>1、中间节点：中间节点索引数的范围是[M/2-1,M]，M为阶数，索引和其他节点有重复，因为每个节点存在子树的最大索引。
>2、叶子节点：所有叶子结点位于同一层，并且是按从小到大的顺序形成了一个链表。
>
>B+树特性
>1、中间节点只存了索引，没有存数据，叶子节点中包含了全部的数据。
>2、每次搜索过程无论成功与否，都是一条从根节点到叶子节点的路径。
>
>B树和B+树区别及优点
>1、中间节点数不同，并且B树存有数据，B+树没有，所以B+树中间节点可以存更多的索引，更加“矮胖”
>2、B+树叶子节点会形成链表，B树不会，所以更便于区间的查找和遍历
>3、B+树的索引在不同节点可以重复。

##### 3.4.2 倒排列表(Posting List)

记载了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息及频率（作关联性算分），每条记录称为一个倒排项(Posting)。

倒排列表存储在磁盘文件中，主要包含:

- 文档 ID，用于获取原始信息
- 单词频率（TF：Term Frequency)，记录单词在该文档中出现的次数，用于计算关联性算分
- 位置（Position），记录单词在文档中的分词位置，用于词语搜索（Phrase Query）
- 偏移（Offset），记录单词在文档中开始和结束的位置，用于高亮显示（Hightlight）

以**“friend”**为例

![image-20221214164059242](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214164059242.png)

**组合起来**

![image-20221214164336496](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214164336496.png)

#### 3.5 倒排索引更新策略

搜索引擎需要处理的文档集合往往都是动态集合，即在建好初始的索引后，不断有新文档进入系统，同时原先的文档集合内有些文档可能被删除或更改，也就是说索引是动态变化的。

那通过在内存中维护临时索引，可以实现对动态文档和实时搜索的支持。

但服务器内存总是有限的，随着新加入系统的文档越来越多，临时索引消耗的内存也会随之增加。

当最初分配的内存将被使用完时，要考虑将临时索引的内容更新到磁盘索引中，以释放内存空间来容纳后续的新进文档。

索引更新的思想：

- `倒排索引`：就是对初始文档集合建立的索引结构，一般**单词词典都存储在内存**，对应的**倒排列表存储在磁盘文件**中
- `临时索引`：是在内存中实时建立的倒排索引，其结构和前述的倒排索引是一样的，区别在于**词典和倒排列表都在内存中存储**。
- `新文档`：进入系统时，实时解析文件并将其加入到临时索引结构中。
- `删除文档`：列表用来存储已被删除的文档的相应的文档ID，形成一个文档ID列表。
- `修改文档`：可以认为是旧文档先被删除，然后系统在增加一篇新的文档，通过这种间接方式实现对内容更改的支持。**先删除再新增**。

![image-20221214164641517](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214164641517.png)

常用的索引更新策略主要有四种：**完全重建策略**、**再合并策略**、**原地更新策略**及**混合策略**。

##### 3.5.1 完全重建策略

完全重建策略是一个很直接的方法，当新增文档达到一定数量，将新增文档和原先的老文档进行合并，然后利用建立静态索引的方式，对所有文档重新建立索引。新索引建立完成后，老的索引被遗弃释放。

优点：简单便捷

缺点：重建索引时间长，在索引重建的过程中，内存中仍然需要维护老索引来对用户查询。

场景：这种策略适合比较小的文档集合。

![image-20221214170107089](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214170107089.png)

##### 3.5.2 再合并策略

有新增文档进入搜索系统时，搜索系统在内存维护临时倒排索引来记录其信息，当新增文档达到一定数量，或者指定大小的内存被消耗完，则把临时索引和老文档的倒排索引进行合并，以生成新的索引。

合并过程如下：

（1）当新文档进入系统，解析文档，之后更新内存中维护的临时索引，文档中出现的每个单词，在其倒排列表末尾追加倒排列表项，这个临时索引可称之为“增量索引”；

（2）一旦“增量索引”将指定的内存消耗光，此时需要进行一次索引合并，即将“增量索引”和老的倒排索引内容进行合并。这里需要注意的是：**倒排文件里的倒排列表存放顺序，已经按照索引单词字典顺序由低到高进行了排序，增量索引在遍历词典的时候也按照字典序由低到高排列，这样对老的倒排文件只需进行一遍扫描，并可顺序读取，减少了文件操作中比较耗时的磁盘寻道时间，可以有效地增加合并效率。**

（3）合并过程需要依次遍历增量索引和老索引单词词典中包含的单词以及其对应的倒排列表，可以用两个指针分别指向**增量索引**和**老索引**目前需要合并的单词。

- 如果“增量索引“中指针指向的单词ID**小于**“老索“引中指针指向的单词ID，则说明这个单词在老索引中没有出现过，直接将这个单词对应的倒排列表写入新索引的倒排列表中，同时增量索引单词指针指向下一个单词。
- 如果两个单词ID**相等**，说明这个单词在“增量索引”和“老索引“中同时出现，则先将“老索引“中这个单词对应的倒排列表加入“新索引“，然后在把“增量索引“这个单词对应的倒排列表追加到其后，这样就完成了这个单词所有倒排列表的合并。两个索引的单词指针都移动到下一个单词继续进行合并。
- 如果“增量索引“指向的单词ID**大于**“老索引“指针指向的单词ID，说明某个单词只在“老索引“中出现过，则直接将“老索引“中对应的倒排列表加入“新索引“的倒排文件中，“老索引“的单词指针指向下一个单词。

等两个索引的所有单词都遍历完后，新索引建成，此时可以遗弃释放老索引，使用新索引来响应用户查询请求。

优点：效率比较高，主要是因为在对老索引进行遍历时，因为已经按照索引单词的词典顺序由低到高排好顺序，所以可以顺序读取文件内容，减少磁盘寻道时间。

缺点：磁盘IO开销大，比如对于老索引中的很多单词来说，尽管其倒排列表并为发生任何变化，但是也需要将其从老索引中读取出来并写入新索引中。

![image-20221214183004571](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214183004571.png)

##### 3.5.3 原地更新策略

在索引更新过程中，如果老索引的倒排列表没有变化，可以不需要读取这些信息，而只是对那些倒排列表变化的单词进行处理，或者是直接将发生变化的倒排列表追加到老索引的末尾，即只更新增量索引里出现的单词相关信息，这样就可以减少大量的磁盘读写操作，提升系统执行效率。

对于倒排文件中的两个相邻单词，为了在查询时加快读写速度，其倒排列表一般是顺序存储的，这导致没有空余位置来追加新信息。为了能够支持追加操作，原地更新策略在初始建立的索引中，会在每一个单词的倒排列表末尾预留出一定的磁盘空间。当预留空间不足时，需要在磁盘中找到一块完整的连续存储区，将增量索引对应的倒排列表追加到其后，实现倒排列表的**“迁移”**工作。

出发点很好，但是实验数据证明其**索引更新效率比再合并策略低**，主要有两个原因：

1. 在这种方法中，对倒排列表的“迁移”是比较常见的。这个策略需要对磁盘可用空间进行维护和管理，这种维护和查找成本非常高，这成为该方法效率的一个瓶颈。
2. 对于倒排文件中的相邻索引单词，其倒排列表顺序一般是按照相邻单词的词典序存储的，但是由于“原地更新策略”对单词的倒排列表做数据迁移，某些单词及其对应倒排列表会从老索引中移出，这样就破坏了这种单词连续性，导致在进行索引合并时不能顺序进行读取，必须维护一个单词到其倒排文件相应位置的映射表，而这样做，一方面降低了磁盘读取速度，另外一方面需要大量的内存来存储这种映射信息。

![image-20221214183135881](https://winnxudong.oss-cn-shanghai.aliyuncs.com/images/image-20221214183135881.png)

##### 3.5.4 混合策略

混合策略一般会将单词根据不同性质进行分类 ，不同类别单词，对其索引采取不同的索引更新策略。比如根据单词的倒排列表长度进行区分，因为有些单词经常在不同的文档中出现，所以其对应的倒排列表较长，而有些单词很少见，则其倒排列表就较短。根据这一性质将单词划分为长倒排列表单词和短倒排列表单词。**长倒排列表单词采取原地更新策略，而短倒排列表单词则采取再合并策略**。之所以这样做，是由于“原地更新策略”更适合“长倒排列表单词”，因为这种策略能够节省磁盘读写次数，而“长倒排列表单词”的读写开销明显要比“短倒排列表单词”大很多，所以如果采用“原地更新策略”，效果体现得比较显著。而大量“短倒排列表单词”读写开销相对而言不算太大，所以利用“再合并策略”来处理，则其顺序读写优势也能被充分利用。